name: Extract plugin URLs and download sgmodule files

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '5,30,55 * * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    services:
      docker:
        image: xream/script-hub:latest
        ports:
          - 9100:9100
          - 9101:9101
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq netcat

      - name: Wait for Docker service to be ready
        run: |
          echo "Waiting for Docker service to be ready..."
          for i in {1..10}; do
            nc -z localhost 9101 && break
            sleep 10
          done

      - name: Download README.md
        run: |
          curl -s -o README.md https://raw.githubusercontent.com/luestr/ProxyResource/main/README.md

      - name: Extract .plugin URLs
        run: |
          grep -oP 'https?://[^ )"]+\?plugin=[^ )"]+' README.md > plugin_urls_raw.txt
          grep -oP '(?<=\?plugin=)[^ )"]+' plugin_urls_raw.txt > plugin_urls.txt
          
          # Add fmz200's blockAds plugin with custom name
          echo "https://raw.githubusercontent.com/fmz200/wool_scripts/main/Loon/plugin/blockAds.plugin?rename=Remove_ads_by_fmz" >> plugin_urls.txt

      - name: Extract categories and process plugins
        run: |
          mkdir -p Chores/sgmodule
          
          # ä» README.md æå–åˆ†ç±»å¹¶å»ºç«‹æ˜ å°„å…³ç³»
          declare -A category_map
          while IFS= read -r line; do
            if [[ $line == "### ç­¾åˆ°æ’ä»¶" ]]; then
              current_category="âœ… Checkin"
            elif [[ $line == "### åŠŸèƒ½æ’ä»¶" ]]; then
              current_category="ğŸ”¨ Tools"
            elif [[ $line == "### å»å¹¿å‘Šæ’ä»¶" ]]; then
              current_category="ğŸš« AD Block"
            elif [[ $line =~ "https://" && -n "$current_category" ]]; then
              plugin_url=$(echo "$line" | grep -oP 'https://[^)"\s]+')
              category_map["$plugin_url"]="$current_category"
            fi
          done < README.md
          
          # å¤„ç†æ’ä»¶ä¸‹è½½
          while read -r plugin_url; do
            # Extract custom name if specified
            if [[ "$plugin_url" == *"?rename="* ]]; then
              plugin_name=$(echo "$plugin_url" | grep -oP '(?<=\?rename=)[^&]+')
              base_url=$(echo "$plugin_url" | cut -d'?' -f1)
            else
              plugin_name=$(basename "$plugin_url" .plugin)
              base_url="$plugin_url"
            fi
            
            # ç¡®å®šåˆ†ç±»
            if [[ -n "${category_map[$base_url]}" ]]; then
              # ä½¿ç”¨ä» README.md ä¸­æå–çš„åˆ†ç±»
              category="${category_map[$base_url]}"
            else
              # ä½¿ç”¨å¤‡ç”¨é€»è¾‘è¿›è¡Œåˆ†ç±»
              if [[ "$plugin_url" == *"remove_ads"* || "$plugin_name" == *"remove_ads"* ]]; then
                category="ğŸš« AD Block"
              elif [[ "$plugin_url" == *"checkin"* || "$plugin_name" == *"checkin"* || \
                      "$plugin_url" == *"DailyBonus"* || "$plugin_name" == *"DailyBonus"* || \
                      "$plugin_url" == *"sign"* || "$plugin_name" == *"sign"* ]]; then
                category="âœ… Checkin"
              else
                category="ğŸ”¨ Tools"
              fi
            fi
            
            encoded_category=$(echo "$category" | jq -sRr @uri)
            encoded_plugin_name=$(echo "$plugin_name" | jq -sRr @uri)
            download_url="http://localhost:9101/file/_start_/${plugin_url}/_end_/${encoded_plugin_name}.sgmodule?type=loon-plugin&target=surge-module&target=surge-module&sni=%20%2C%20&del=true&pm=REJECT&category=${encoded_category}"
            
            echo "Processing $plugin_name with category: $category"
            curl -A "Surge Mac/2985" -L -o "Chores/sgmodule/${plugin_name}.sgmodule" "$download_url" || echo "Failed to download ${plugin_name}.sgmodule"
          done < plugin_urls.txt

      - name: Find and replace external JS resources
        continue-on-error: true  # ç¡®ä¿æ­¥éª¤åœ¨éƒ¨åˆ†å¤±è´¥æ—¶ç»§ç»­æ‰§è¡Œ
        run: |
          base_js_url="https://github.com/hchichi/esdeath/raw/main/Chores/js"
          mkdir -p Chores/js
          for sgmodule_file in Chores/sgmodule/*.sgmodule; do
            echo "Processing $sgmodule_file"
            # æŸ¥æ‰¾ .js æ–‡ä»¶çš„å¤–éƒ¨é“¾æ¥
            js_links=$(grep -oP 'https?://[^ ]+\.js' "$sgmodule_file" || echo "")
            for js_link in $js_links; do
              js_filename=$(basename "$js_link")
              local_js_path="Chores/js/$js_filename"
              # ä½¿ç”¨æŒ‡å®šçš„ User-Agent ä¸‹è½½ .js æ–‡ä»¶
              echo "Downloading $js_link to $local_js_path"
              if curl -A "Surge Mac/2985" -L -o "$local_js_path" "$js_link"; then
                echo "Download successful for $js_link"
                # æ›¿æ¢ sgmodule æ–‡ä»¶ä¸­çš„é“¾æ¥ä¸º GitHub ä»“åº“çš„è·¯å¾„
                github_js_url="$base_js_url/$js_filename"
                sed -i "s|$js_link|$github_js_url|g" "$sgmodule_file"
              else
                echo "Failed to download $js_link, skipping..."
              fi
            done
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add Chores/sgmodule/*.sgmodule Chores/js/*.js
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git stash
            git pull --rebase  # åŒæ­¥è¿œç¨‹ä»“åº“çš„æœ€æ–°æ›´æ”¹ä»¥é¿å…å†²çª
            git stash pop  # æ¢å¤ä¹‹å‰çš„æ›´æ”¹
            git add Chores/sgmodule/*.sgmodule Chores/js/*.js  # å†æ¬¡æ·»åŠ æ–‡ä»¶
            git commit -m "Update sgmodule files with GitHub-hosted JS resources"
            git push
          fi

      - name: Trigger Deploy Workflow
        if: success()
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: trigger-deploy